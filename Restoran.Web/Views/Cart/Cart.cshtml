@model List<Restoran.Core.DTOs.Card.CartItemViewModel>
@{
    ViewData["Title"] = "Sepetim";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-shopping-cart text-primary"></i> Sepetim
                </h2>
                <a href="@Url.Action("Index", "Menu")" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Menüye Dön
                </a>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            @if (TempData["Message"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["Message"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (Model == null || !Model.Any())
            {
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-shopping-cart text-muted" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="text-muted mb-3">Sepetiniz Boş</h4>
                    <p class="text-muted mb-4">Henüz sepetinize ürün eklemediniz.</p>
                    <a href="@Url.Action("Index", "Menu")" class="btn btn-primary btn-lg">
                        <i class="fas fa-utensils"></i> Menüyü İncele
                    </a>
                </div>
            }
            else
            {
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Sepet Detayları</h5>
                            </div>
                            <div class="card-body p-0">
                                <div id="cartItems">
                                    @foreach (var item in Model)
                                    {
                                        <div class="cart-item border-bottom p-3" data-product-id="@item.ProductId">
                                            <div class="row align-items-center">
                                                <div class="col-md-6">
                                                    <h6 class="mb-1">@item.ProductName</h6>
                                                    <small class="text-muted">Birim Fiyat: @item.UnitPrice.ToString("C")</small>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="input-group input-group-sm">
                                                        <button class="btn btn-outline-secondary btn-decrease" type="button">
                                                            <i class="fas fa-minus"></i>
                                                        </button>
                                                        <input type="number" class="form-control text-center quantity-input" 
                                                               value="@item.Quantity" min="1" max="99" 
                                                               data-product-id="@item.ProductId">
                                                        <button class="btn btn-outline-secondary btn-increase" type="button">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-md-2 text-end">
                                                    <div class="item-total fw-bold">
                                                        @((item.UnitPrice * item.Quantity).ToString("C"))
                                                    </div>
                                                </div>
                                                <div class="col-md-1 text-end">
                                                    <button class="btn btn-sm btn-outline-danger btn-remove" 
                                                            data-product-id="@item.ProductId">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Sipariş Özeti</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Toplam Ürün:</span>
                                    <span id="totalItems">@Model.Sum(x => x.Quantity)</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Ara Toplam:</span>
                                    <span id="subtotal">@Model.Sum(x => x.UnitPrice * x.Quantity).ToString("C")</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between mb-3">
                                    <strong>Toplam:</strong>
                                    <strong id="grandTotal">@Model.Sum(x => x.UnitPrice * x.Quantity).ToString("C")</strong>
                                </div>
                                
                                <button id="btnCheckout" class="btn btn-success btn-lg w-100">
                                    <i class="fas fa-credit-card"></i> Sipariş Ver
                                </button>
                            </div>
                        </div>

                        <div class="card shadow-sm mt-3">
                            <div class="card-body text-center">
                                <button id="btnClearCart" class="btn btn-outline-danger">
                                    <i class="fas fa-trash-alt"></i> Sepeti Temizle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Yükleniyor...</span>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Miktar artırma
            $(document).on('click', '.btn-increase', function () {
                const input = $(this).siblings('.quantity-input');
                const currentVal = parseInt(input.val());
                const productId = input.data('product-id');
                
                if (currentVal < 99) {
                    input.val(currentVal + 1);
                    updateQuantity(productId, currentVal + 1);
                }
            });

            // Miktar azaltma
            $(document).on('click', '.btn-decrease', function () {
                const input = $(this).siblings('.quantity-input');
                const currentVal = parseInt(input.val());
                const productId = input.data('product-id');
                
                if (currentVal > 1) {
                    input.val(currentVal - 1);
                    updateQuantity(productId, currentVal - 1);
                }
            });

            // Manuel miktar değişikliği
            $(document).on('change', '.quantity-input', function () {
                const quantity = parseInt($(this).val());
                const productId = $(this).data('product-id');
                
                if (quantity >= 1 && quantity <= 99) {
                    updateQuantity(productId, quantity);
                } else {
                    $(this).val(1);
                    updateQuantity(productId, 1);
                }
            });

            // Ürün silme
            $(document).on('click', '.btn-remove', function () {
                const productId = $(this).data('product-id');
                
                Swal.fire({
                    title: 'Emin misiniz?',
                    text: 'Bu ürünü sepetten çıkarmak istediğinizden emin misiniz?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Evet, Çıkar',
                    cancelButtonText: 'İptal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        removeFromCart(productId);
                    }
                });
            });

            // Sepeti temizle
            $('#btnClearCart').click(function () {
                Swal.fire({
                    title: 'Sepeti Temizle',
                    text: 'Tüm ürünleri sepetten çıkarmak istediğinizden emin misiniz?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Evet, Temizle',
                    cancelButtonText: 'İptal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        clearCart();
                    }
                });
            });

            // Sipariş ver
            $('#btnCheckout').click(function () {
                Swal.fire({
                    title: 'Sipariş Onayı',
                    text: 'Siparişinizi onaylamak istediğinizden emin misiniz?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Evet, Onayla',
                    cancelButtonText: 'İptal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        checkout();
                    }
                });
            });
        });

        function updateQuantity(productId, quantity) {
            showLoading();
            
            $.ajax({
                url: '@Url.Action("UpdateQuantity", "Cart")',
                type: 'POST',
                data: {
                    productId: productId,
                    quantity: quantity
                },
                success: function (response) {
                    updateCartDisplay();
                    showAlert('Miktar güncellendi.', 'success');
                },
                error: function () {
                    showAlert('Miktar güncellenirken hata oluştu.', 'danger');
                },
                complete: function () {
                    hideLoading();
                }
            });
        }

        function removeFromCart(productId) {
            showLoading();
            
            $.ajax({
                url: '@Url.Action("RemoveFromCart", "Cart")',
                type: 'POST',
                data: { productId: productId },
                success: function (response) {
                    $(`.cart-item[data-product-id="${productId}"]`).fadeOut(300, function() {
                        $(this).remove();
                        updateCartDisplay();
                        checkEmptyCart();
                    });
                    showAlert('Ürün sepetten çıkarıldı.', 'success');
                },
                error: function () {
                    showAlert('Ürün çıkarılırken hata oluştu.', 'danger');
                },
                complete: function () {
                    hideLoading();
                }
            });
        }

        function clearCart() {
            showLoading();
            
            const productIds = [];
            $('.cart-item').each(function() {
                productIds.push($(this).data('product-id'));
            });

            let completedRequests = 0;
            const totalRequests = productIds.length;

            if (totalRequests === 0) {
                hideLoading();
                return;
            }

            productIds.forEach(function(productId) {
                $.ajax({
                    url: '@Url.Action("RemoveFromCart", "Cart")',
                    type: 'POST',
                    data: { productId: productId },
                    success: function() {
                        completedRequests++;
                        if (completedRequests === totalRequests) {
                            location.reload();
                        }
                    },
                    error: function() {
                        completedRequests++;
                        if (completedRequests === totalRequests) {
                            showAlert('Sepet temizlenirken bazı hatalar oluştu.', 'warning');
                            hideLoading();
                        }
                    }
                });
            });
        }

        function checkout() {
            showLoading();
            
            $.ajax({
                url: '@Url.Action("Checkout", "Cart")',
                type: 'POST',
                success: function (response) {
                    Swal.fire({
                        title: 'Başarılı!',
                        text: 'Siparişiniz başarıyla oluşturuldu.',
                        icon: 'success',
                        confirmButtonText: 'Tamam'
                    }).then(() => {
                        location.reload();
                    });
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '@Url.Action("Login", "Account")';
                    } else {
                        showAlert('Sipariş oluşturulurken hata oluştu.', 'danger');
                    }
                },
                complete: function () {
                    hideLoading();
                }
            });
        }

        function updateCartDisplay() {
            let totalItems = 0;
            let subtotal = 0;

            $('.cart-item').each(function() {
                const quantity = parseInt($(this).find('.quantity-input').val());
                const unitPrice = parseFloat($(this).find('small').text().replace('Birim Fiyat: ', '').replace('₺', '').replace(',', '.'));
                const itemTotal = quantity * unitPrice;

                totalItems += quantity;
                subtotal += itemTotal;

                $(this).find('.item-total').text(formatCurrency(itemTotal));
            });

            $('#totalItems').text(totalItems);
            $('#subtotal').text(formatCurrency(subtotal));
            $('#grandTotal').text(formatCurrency(subtotal));
        }

        function checkEmptyCart() {
            if ($('.cart-item').length === 0) {
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(amount);
        }

        function showAlert(message, type) {
            const alert = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('#alertContainer').html(alert);
            
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 3000);
        }

        function showLoading() {
            $('#loadingSpinner').removeClass('d-none');
        }

        function hideLoading() {
            $('#loadingSpinner').addClass('d-none');
        }
    </script>
}

<style>
    .cart-item:hover {
        background-color: #f8f9fa;
    }
    
    .quantity-input {
        max-width: 70px;
    }
    
    .btn-increase, .btn-decrease {
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #loadingSpinner {
        z-index: 9999;
    }
    
    .card {
        border: none;
        border-radius: 10px;
    }
    
    .card-header {
        border-top-left-radius: 10px !important;
        border-top-right-radius: 10px !important;
    }
</style> 